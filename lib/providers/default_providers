require "rubygems"
require "mechanize"
require "iconv"

# from Mirko
# http://blog.misto.ch/archives/606
provider :orange do |user, password, number, message|
  SmsR.debug "args: ", user, password, number, message
  
  WWW::Mechanize.new do |agent|
    SmsR.debug "logging in .."
    agent.get('https://www.orange.ch/footer/login') do |page|
      find_form_with_field(page, 'username') do |f|
        f.username = user
        f.password = password
        f.submit
      end
    end
    SmsR.debug ".. done"

    agent.get('https://www.orange.ch/myorange/sms') do |page|
      SmsR.debug "start sending .."
      find_form_with_field(page, 'messageInput') do |f|
        f.destinationNumberInput = number
        f.messageInput = Iconv.conv("ISO-8859-1", "UTF-8", message)
        f.wui_target_id = 'sendButton'
        f.wui_event_id = 'onclick'
        f.submit
      end
      SmsR.debug ".. done"
    end
    
    SmsR.info "SMS '#{message}' sent to #{number}"
  end
end

# from Gui
# http://giu.me/01-09-2008-sms-senden-leicht-gemacht-swisscom.html
provider :swisscom do |user, password, number, message|
  SmsR.debug "args: ", user, password, number, message
  WWW::Mechanize.new do |agent|
    SmsR.debug "logging in .."
    agent.get('https://www.swisscom-mobile.ch/selfreg/SelfRegistration?'+
              'uri=/youth/youth_zone_home-de.aspx') do |page|

      find_form_with_field(page, 'isiwebuserid') do |f|
        f.isiwebuserid = username
        f.isiwebpasswd = password
        f.submit
      end
    end
    SmsR.debug ".. done"
    

    agent.get('https://www.swisscom-mobile.ch'+
              '/youth/sms_senden-de.aspx') do |page|
      SmsR.debug "start sending .."
      find_form_with_field(page, 'CobYouthSMSSenden:txtMessage') do |f|
        f['CobYouthSMSSenden:txtNewReceiver']= number
        f['CobYouthSMSSenden:txtMessage']= message
        submit_button= nil
        #finde den richtigen submit-button
        f.buttons.each do |button|
          if button.name = 'CobYouthSMSSenden:btnSend' then 
            submit_button= button
            break
          end
        end
        f.submit(submit_button)
      end 
    end
    SmsR.debug ".. done"
  end
end

def find_form_with_field(page, fieldname)
  page.forms.each do |form|
    if form.fields.find{|f| f.name == fieldname}
      yield form
    end
  end
end
